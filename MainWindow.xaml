<Window x:Class="MinsPDFViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MinsPDFViewer"
        mc:Ignorable="d"
        Title="Mins PDF Viewer (Advanced)" Height="800" Width="1200"
        KeyDown="Window_KeyDown">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <local:BoolToFontWeightConverter x:Key="BoolToFontWeightConverter"/>

        <DataTemplate x:Key="FreeTextTemplate">
            <Grid Width="{Binding Width}" Height="{Binding Height}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="20" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0" 
                        Background="#DDDDDD" 
                        BorderBrush="Gray" 
                        BorderThickness="1,1,1,0"
                        CornerRadius="3,3,0,0"
                        Cursor="SizeAll"
                        Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"
                        PreviewMouseDown="AnnotationDragHandle_PreviewMouseDown">
                    <TextBlock Text="::" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="Gray" FontWeight="Bold" FontSize="10"/>
                </Border>

                <Border Grid.Row="1" BorderThickness="1,0,1,1">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="BorderBrush" Value="Transparent"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                    <Setter Property="BorderBrush" Value="Gray"/>
                                    <Setter Property="Background" Value="#55FFFFFF"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>

                    <TextBox Text="{Binding TextContent, UpdateSourceTrigger=PropertyChanged}"
                             FontFamily="{Binding FontFamily}"
                             FontSize="{Binding FontSize}"
                             FontWeight="{Binding IsBold, Converter={StaticResource BoolToFontWeightConverter}}"
                             Foreground="{Binding Foreground}"
                             Background="Transparent"
                             BorderThickness="0"
                             FocusVisualStyle="{x:Null}"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Padding="5"
                             Loaded="AnnotationTextBox_Loaded"
                             GotFocus="AnnotationTextBox_GotFocus"
                             TextChanged="AnnotationTextBox_TextChanged"/>
                </Border>

                <Thumb Grid.Row="1" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                       Width="10" Height="10" Cursor="SizeNWSE"
                       DragDelta="ResizeThumb_DragDelta"
                       Background="Gray" Opacity="0.5" Margin="0,0,0,0"
                       Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="HighlightTemplate">
            <Border Width="{Binding Width}" Height="{Binding Height}" 
                    Background="{Binding Background}"
                    Cursor="Hand"
                    PreviewMouseDown="Annotation_PreviewMouseDown"/>
        </DataTemplate>

        <DataTemplate x:Key="UnderlineTemplate">
            <Border Width="{Binding Width}" Height="{Binding Height}" 
                    Background="{Binding Background}"
                    Cursor="Hand"
                    PreviewMouseDown="Annotation_PreviewMouseDown"/>
        </DataTemplate>
        
        <DataTemplate x:Key="SearchHighlightTemplate">
            <Border Width="{Binding Width}" Height="{Binding Height}" Background="{Binding Background}"/>
        </DataTemplate>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <ToolBarTray Grid.Row="0" Background="White">
            <ToolBar>
                <Button Name="BtnOpen" Content="📂 열기" Click="BtnOpen_Click" Margin="0,0,5,0"/>
                <Button Name="BtnSave" Content="💾 저장" Click="BtnSave_Click" Margin="0,0,5,0"/>
                <Button Name="BtnSaveAs" Content="💾 다른 이름으로" Click="BtnSaveAs_Click" Margin="0,0,10,0"/>
                <Separator/>
                
                <RadioButton Name="RbCursor" GroupName="Tools" Content="👆 선택" IsChecked="True" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbHighlight" GroupName="Tools" Content="🖍 형광펜" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbText" GroupName="Tools" Content="📝 텍스트" Click="Tool_Click" Margin="5,0"/>
                <Separator/>
                
                <Button Name="BtnZoomOut" Content="➖" Click="BtnZoomOut_Click"/>
                <Button Name="BtnZoomIn" Content="➕" Click="BtnZoomIn_Click"/>
                <Button Name="BtnFitWidth" Content="↔ 폭 맞춤" Click="BtnFitWidth_Click"/>
                <Button Name="BtnFitHeight" Content="↕ 높이 맞춤" Click="BtnFitHeight_Click"/>
                <Separator/>
                
                <Button Name="BtnOCR" Content="👁 OCR 분석" Click="BtnOCR_Click" FontWeight="Bold" Foreground="Blue"/>

                <Separator/>
                <Button Name="BtnSignSettings" Content="🔐 서명 설정" Click="BtnSignSettings_Click" FontWeight="Bold" Margin="0,0,5,0"/>
                <Separator/>
            </ToolBar>

            <ToolBar Name="TextStyleToolbar" Visibility="Collapsed">
                <ComboBox Name="CbFont" Width="100" SelectionChanged="StyleChanged"/>
                <ComboBox Name="CbSize" Width="50" SelectionChanged="StyleChanged"/>
                <ToggleButton Name="BtnBold" Content="𝐁" FontWeight="Bold" Click="StyleChanged"/>
                <ComboBox Name="CbColor" Width="80" SelectionChanged="StyleChanged">
                    <ComboBoxItem Content="검정" Tag="Black" IsSelected="True"/>
                    <ComboBoxItem Content="빨강" Tag="Red" Foreground="Red"/>
                    <ComboBoxItem Content="파랑" Tag="Blue" Foreground="Blue"/>
                    <ComboBoxItem Content="초록" Tag="Green" Foreground="Green"/>
                    <ComboBoxItem Content="주황" Tag="Orange" Foreground="Orange"/>
                </ComboBox>
                <Button Name="BtnDeleteAnnotation" Content="🗑 삭제" Click="BtnDeleteAnnotation_Click"/>
            </ToolBar>
            
             <ToolBar>
                <TextBox Name="TxtSearch" Width="150" PreviewKeyDown="TxtSearch_PreviewKeyDown" ToolTip="Enter: 다음, Ctrl+Enter: 이전"/>
                <Button Name="BtnSearch" Content="🔍" Click="BtnSearch_Click"/>
                <Button Name="BtnPrevSearch" Content="◀" Click="BtnPrevSearch_Click"/>
                <Button Name="BtnNextSearch" Content="▶" Click="BtnNextSearch_Click"/>
            </ToolBar>
        </ToolBarTray>

        <TabControl Name="MainTabControl" Grid.Row="1" ItemsSource="{Binding Documents}" SelectedItem="{Binding SelectedDocument}" SelectionChanged="MainTabControl_SelectionChanged">
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FileName}" Margin="0,0,5,0"/>
                        <Button Content="❌" Width="15" Height="15" FontSize="8" Tag="{Binding}" Click="BtnCloseTab_Click" Background="Transparent" BorderThickness="0"/>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>
            
            <TabControl.ContentTemplate>
                <DataTemplate>
                    <ListView ItemsSource="{Binding Pages}" 
                              ScrollViewer.HorizontalScrollBarVisibility="Auto" 
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              ScrollViewer.CanContentScroll="False"
                              Loaded="PdfListView_Loaded"
                              Unloaded="PdfListView_Unloaded"
                              PreviewMouseWheel="PdfListView_PreviewMouseWheel"
                              Background="LightGray"
                              BorderThickness="0">
                        
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="Margin" Value="10"/>
                                <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                <Setter Property="Focusable" Value="False"/>
                            </Style>
                        </ListView.ItemContainerStyle>
                        
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border BorderBrush="Black" BorderThickness="1" Background="White">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="10" ShadowDepth="5" Opacity="0.5"/>
                                    </Border.Effect>
                                    
                                    <Grid Width="{Binding Width}" Height="{Binding Height}"
                                          Tag="{Binding PageIndex}"
                                          MouseDown="Page_MouseDown"
                                          MouseMove="Page_MouseMove"
                                          MouseUp="Page_MouseUp"
                                          Background="Transparent">

                                        <Grid.LayoutTransform>
                                            <ScaleTransform ScaleX="{Binding DataContext.Zoom, RelativeSource={RelativeSource AncestorType=ListView}}" 
                                                            ScaleY="{Binding DataContext.Zoom, RelativeSource={RelativeSource AncestorType=ListView}}"/>
                                        </Grid.LayoutTransform>
                                        
                                        <Image Source="{Binding ImageSource}" Stretch="Fill"/>
                                        
                                        <Canvas Background="Transparent">
                                            <Border Canvas.Left="{Binding SelectionX}" Canvas.Top="{Binding SelectionY}"
                                                    Width="{Binding SelectionWidth}" Height="{Binding SelectionHeight}"
                                                    BorderBrush="Blue" BorderThickness="1" Background="#300000FF"
                                                    Visibility="{Binding IsSelecting, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        </Canvas>

                                        <ItemsControl ItemsSource="{Binding Annotations}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <Canvas/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemContainerStyle>
                                                <Style TargetType="ContentPresenter">
                                                    <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                                    <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                            
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <ContentControl Content="{Binding}">
                                                        <ContentControl.Style>
                                                            <Style TargetType="ContentControl">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Type}" Value="FreeText">
                                                                        <Setter Property="ContentTemplate" Value="{StaticResource FreeTextTemplate}"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Type}" Value="Highlight">
                                                                        <Setter Property="ContentTemplate" Value="{StaticResource HighlightTemplate}"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Type}" Value="Underline">
                                                                        <Setter Property="ContentTemplate" Value="{StaticResource UnderlineTemplate}"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Type}" Value="SearchHighlight">
                                                                        <Setter Property="ContentTemplate" Value="{StaticResource SearchHighlightTemplate}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </ContentControl.Style>
                                                        
                                                        <ContentControl.ContextMenu>
                                                            <ContextMenu>
                                                                <MenuItem Header="삭제" CommandParameter="{Binding}" Click="BtnDeleteAnnotation_Click"/>
                                                            </ContextMenu>
                                                        </ContentControl.ContextMenu>
                                                    </ContentControl>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>

        <StatusBar Grid.Row="2">
            <TextBlock Name="TxtStatus" Text="준비"/>
            <Separator/>
            <ProgressBar Name="PbStatus" Width="200" Height="15" Visibility="Collapsed"/>
        </StatusBar>

        <Popup Name="SelectionPopup" StaysOpen="False" Placement="Bottom">
            <Border Background="White" BorderBrush="Gray" BorderThickness="1" Padding="5">
                <StackPanel Orientation="Horizontal">
                    <Button Content="복사" Click="BtnPopupCopy_Click" Margin="2"/>
                    <Button Content="이미지 복사" Click="BtnPopupCopyImage_Click" Margin="2"/>
                    <Button Content="형광펜(초록)" Click="BtnPopupHighlightGreen_Click" Background="LightGreen" Margin="2"/>
                    <Button Content="형광펜(주황)" Click="BtnPopupHighlightOrange_Click" Background="Orange" Margin="2"/>
                    <Button Content="밑줄" Click="BtnPopupUnderline_Click" Margin="2"/>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</Window>