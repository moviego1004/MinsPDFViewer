<Window x:Class="MinsPDFViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:MinsPDFViewer"
        Title="MinsPDFViewer - Pro (Multi-Tab)" Height="800" Width="1200"
        Focusable="True" KeyDown="Window_KeyDown">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Popup Name="SelectionPopup" Placement="Mouse" StaysOpen="False" AllowsTransparency="True">
            <Border Background="White" CornerRadius="8" BorderBrush="Gray" BorderThickness="1" Padding="5">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                </Border.Effect>
                <StackPanel Orientation="Horizontal">
                    <Button Click="BtnPopupCopy_Click" Background="Transparent" BorderThickness="0" ToolTip="텍스트 복사" Margin="2">
                        <TextBlock Text="📄 텍스트" FontSize="12" VerticalAlignment="Center"/>
                    </Button>
                    <Button Click="BtnPopupCopyImage_Click" Background="Transparent" BorderThickness="0" ToolTip="이미지 복사" Margin="2">
                        <TextBlock Text="📷 이미지" FontSize="12" VerticalAlignment="Center"/>
                    </Button>
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                    <Button Click="BtnPopupHighlightGreen_Click" Background="Transparent" BorderThickness="0" ToolTip="초록 형광펜" Margin="2">
                        <Border Width="16" Height="16" Background="#00FF00" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                    </Button>
                    <Button Click="BtnPopupHighlightOrange_Click" Background="Transparent" BorderThickness="0" ToolTip="주황 형광펜" Margin="2">
                        <Border Width="16" Height="16" Background="#FFA500" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                    </Button>
                    <Button Click="BtnPopupUnderline_Click" Background="Transparent" BorderThickness="0" ToolTip="밑줄" Margin="2">
                        <TextBlock Text="U" FontWeight="Bold" TextDecorations="Underline" HorizontalAlignment="Center"/>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <Border Grid.Row="0" Background="#f0f0f0" Padding="10">
            <StackPanel Orientation="Horizontal">
                <Button Name="BtnOpen" Content="📂 열기" Width="60" Click="BtnOpen_Click" Margin="0,0,5,0"/>
                <Button Name="BtnSave" Content="💾 저장" Width="60" Click="BtnSave_Click" Margin="0,0,5,0" Background="#DDDDFF"/>
                <Button Name="BtnSaveAs" Content="다른 이름.." Width="70" Click="BtnSaveAs_Click" Margin="0,0,10,0" Background="#EEEEFF"/>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                
                <Button Content="-" Width="25" Click="BtnZoomOut_Click"/>
                <TextBlock Text="{Binding SelectedDocument.ZoomPercentText, FallbackValue='100%'}" 
                           VerticalAlignment="Center" Width="40" TextAlignment="Center" FontWeight="Bold"/>
                <Button Content="+" Width="25" Click="BtnZoomIn_Click" Margin="0,0,5,0"/>
                
                <Button Name="BtnFitWidth" Content="너비" Width="40" Click="BtnFitWidth_Click" ToolTip="너비 맞춤" Margin="0,0,2,0"/>
                <Button Name="BtnFitHeight" Content="높이" Width="40" Click="BtnFitHeight_Click" ToolTip="높이 맞춤" Margin="0,0,10,0"/>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                
                <TextBlock Text="도구: " VerticalAlignment="Center" FontWeight="Bold"/>
                <RadioButton Name="RbCursor" Content="선택" GroupName="Tools" IsChecked="True" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbHighlight" Content="그리기" GroupName="Tools" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbText" Content="텍스트" GroupName="Tools" Click="Tool_Click" Margin="5,0"/>

                <StackPanel Name="TextStyleToolbar" Orientation="Horizontal" Visibility="Collapsed">
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                    <ComboBox Name="CbFont" Width="100" SelectionChanged="StyleChanged" VerticalContentAlignment="Center"/>
                    <ComboBox Name="CbSize" Width="50" SelectionChanged="StyleChanged" VerticalContentAlignment="Center"/>
                    <ToggleButton Name="BtnBold" Content="B" FontWeight="Bold" Width="25" Click="StyleChanged"/>
                    
                    <ComboBox Name="CbColor" Width="80" SelectionChanged="StyleChanged" VerticalContentAlignment="Center">
                        <ComboBoxItem Tag="Black">
                            <StackPanel Orientation="Horizontal">
                                <Border Width="12" Height="12" Background="Black" BorderBrush="Gray" BorderThickness="1" Margin="0,0,5,0"/>
                                <TextBlock Text="검정"/>
                            </StackPanel>
                        </ComboBoxItem>
                        <ComboBoxItem Tag="Red" IsSelected="True">
                            <StackPanel Orientation="Horizontal">
                                <Border Width="12" Height="12" Background="Red" BorderBrush="Gray" BorderThickness="1" Margin="0,0,5,0"/>
                                <TextBlock Text="빨강"/>
                            </StackPanel>
                        </ComboBoxItem>
                        <ComboBoxItem Tag="Blue">
                            <StackPanel Orientation="Horizontal">
                                <Border Width="12" Height="12" Background="Blue" BorderBrush="Gray" BorderThickness="1" Margin="0,0,5,0"/>
                                <TextBlock Text="파랑"/>
                            </StackPanel>
                        </ComboBoxItem>
                        <ComboBoxItem Tag="Green">
                            <StackPanel Orientation="Horizontal">
                                <Border Width="12" Height="12" Background="Green" BorderBrush="Gray" BorderThickness="1" Margin="0,0,5,0"/>
                                <TextBlock Text="초록"/>
                            </StackPanel>
                        </ComboBoxItem>
                         <ComboBoxItem Tag="Orange">
                            <StackPanel Orientation="Horizontal">
                                <Border Width="12" Height="12" Background="Orange" BorderBrush="Gray" BorderThickness="1" Margin="0,0,5,0"/>
                                <TextBlock Text="주황"/>
                            </StackPanel>
                        </ComboBoxItem>
                    </ComboBox>
                    
                    <Button Name="BtnDeleteAnnot" Content="🗑" Foreground="Red" Width="25" Click="BtnDeleteAnnotation_Click" ToolTip="삭제 (Del)"/>
                </StackPanel>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>
                <Button Name="BtnOCR" Content="✨ OCR" Click="BtnOCR_Click" Width="60" Background="#E0FFE0" Margin="0,0,10,0"/>

                <TextBox Name="TxtSearch" Width="100" VerticalContentAlignment="Center" Margin="0,0,2,0" KeyDown="TxtSearch_KeyDown"/>
                <Button Content="&lt;" Width="20" Click="BtnPrevSearch_Click"/>
                <Button Content="&gt;" Width="20" Click="BtnNextSearch_Click"/>
                <Button Name="BtnSearch" Content="🔍" Width="30" Click="BtnSearch_Click"/>
                
                <Grid Margin="10,0,0,0" Width="120" VerticalAlignment="Center">
                    <ProgressBar Name="PbStatus" Height="15" Visibility="Collapsed" Minimum="0" Maximum="100"/>
                    <TextBlock Name="TxtStatus" Text="준비" VerticalAlignment="Center" HorizontalAlignment="Left" Foreground="Gray"/>
                </Grid>
            </StackPanel>
        </Border>

        <TabControl Name="MainTabControl" Grid.Row="1" 
                    ItemsSource="{Binding Documents}" 
                    SelectedItem="{Binding SelectedDocument, Mode=TwoWay}"
                    SelectionChanged="MainTabControl_SelectionChanged"
                    Background="#505050">
            
            <TabControl.ItemTemplate>
                <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FileName}" Margin="0,0,5,0" VerticalAlignment="Center"/>
                        <Button Content="❌" Width="20" Height="20" FontSize="10" 
                                Click="BtnCloseTab_Click" Tag="{Binding}"
                                Background="Transparent" BorderThickness="0" Foreground="Red"/>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>

            <TabControl.ContentTemplate>
                <DataTemplate>
                    <ListView Name="PdfListView" 
                              ItemsSource="{Binding Pages}"
                              ScrollViewer.HorizontalScrollBarVisibility="Auto"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              Padding="20" BorderThickness="0"
                              Background="#505050"
                              VirtualizingPanel.ScrollUnit="Pixel"
                              VirtualizingPanel.IsVirtualizing="True"
                              PreviewMouseWheel="PdfListView_PreviewMouseWheel"
                              Loaded="PdfListView_Loaded"
                              Unloaded="PdfListView_Unloaded">
                        
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Center"/>
                                <Setter Property="VerticalContentAlignment" Value="Center"/>
                                <Setter Property="Margin" Value="0,0,0,30"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}"/>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Setter Property="LayoutTransform">
                                    <Setter.Value>
                                        <ScaleTransform ScaleX="{Binding DataContext.Zoom, RelativeSource={RelativeSource AncestorType=ListView}}"
                                                        ScaleY="{Binding DataContext.Zoom, RelativeSource={RelativeSource AncestorType=ListView}}"/>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListView.ItemContainerStyle>

                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="10" HorizontalAlignment="Center" VerticalAlignment="Center">
                                    <Border Background="White">
                                        <Border.Effect>
                                            <DropShadowEffect BlurRadius="15" ShadowDepth="5" Opacity="0.4" RenderingBias="Performance"/>
                                        </Border.Effect>

                                        <Grid>
                                            <Image Source="{Binding ImageSource}" Stretch="Uniform" Width="{Binding Width}" Height="{Binding Height}"/>

                                            <Canvas Width="{Binding Width}" Height="{Binding Height}" Background="Transparent"
                                                    Tag="{Binding PageIndex}"
                                                    PreviewMouseLeftButtonDown="Page_MouseDown"
                                                    PreviewMouseMove="Page_MouseMove"
                                                    PreviewMouseLeftButtonUp="Page_MouseUp"/>

                                            <Canvas Width="{Binding Width}" Height="{Binding Height}">
                                                <ItemsControl ItemsSource="{Binding Annotations}">
                                                    <ItemsControl.ItemsPanel>
                                                        <ItemsPanelTemplate><Canvas/></ItemsPanelTemplate>
                                                    </ItemsControl.ItemsPanel>
                                                    <ItemsControl.ItemContainerStyle>
                                                        <Style TargetType="ContentPresenter">
                                                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                                        </Style>
                                                    </ItemsControl.ItemContainerStyle>
                                                    
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid Width="{Binding Width}" Height="{Binding Height}">
                                                                <Grid>
                                                                    <Grid.Style>
                                                                        <Style TargetType="Grid">
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsFreeText}" Value="True">
                                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Grid.Style>
                                                                    <Border Background="{Binding Background}" 
                                                                            BorderBrush="{Binding BorderBrush}"
                                                                            BorderThickness="{Binding BorderThickness}"
                                                                            Tag="{Binding}"
                                                                            ToolTip="클릭하여 선택"
                                                                            PreviewMouseLeftButtonDown="Annotation_PreviewMouseDown">
                                                                        <Border.ContextMenu>
                                                                            <ContextMenu>
                                                                                <MenuItem Header="삭제" Click="BtnDeleteAnnotation_Click" CommandParameter="{Binding}"/>
                                                                            </ContextMenu>
                                                                        </Border.ContextMenu>
                                                                    </Border>
                                                                    <Border BorderBrush="#0066CC" BorderThickness="2" IsHitTestVisible="False"
                                                                            Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                                </Grid>

                                                                <Grid>
                                                                    <Grid.Style>
                                                                        <Style TargetType="Grid">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding IsFreeText}" Value="True">
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </Grid.Style>
                                                                    <Border BorderBrush="Blue" BorderThickness="1" Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                                    <TextBox Text="{Binding TextContent, UpdateSourceTrigger=PropertyChanged}"
                                                                             FontFamily="{Binding FontFamily}"
                                                                             FontSize="{Binding FontSize}"
                                                                             Foreground="{Binding Foreground}"
                                                                             Background="Transparent" BorderThickness="0"
                                                                             AcceptsReturn="True" TextWrapping="Wrap"
                                                                             Loaded="AnnotationTextBox_Loaded"
                                                                             GotFocus="AnnotationTextBox_GotFocus"
                                                                             PreviewMouseDown="Annotation_PreviewMouseDown">
                                                                        <TextBox.Style>
                                                                            <Style TargetType="TextBox">
                                                                                <Style.Triggers>
                                                                                    <DataTrigger Binding="{Binding IsBold}" Value="True">
                                                                                        <Setter Property="FontWeight" Value="Bold"/>
                                                                                    </DataTrigger>
                                                                                </Style.Triggers>
                                                                            </Style>
                                                                        </TextBox.Style>
                                                                        <TextBox.ContextMenu>
                                                                            <ContextMenu>
                                                                                <MenuItem Header="삭제" Click="BtnDeleteAnnotation_Click" CommandParameter="{Binding}"/>
                                                                            </ContextMenu>
                                                                        </TextBox.ContextMenu>
                                                                    </TextBox>
                                                                    <Thumb Width="10" Height="10" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                                                                           Cursor="SizeNWSE" Background="Blue" Opacity="0.5"
                                                                           DragDelta="ResizeThumb_DragDelta"
                                                                           Visibility="{Binding IsSelected, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                                                </Grid>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </Canvas>

                                            <Canvas Width="{Binding Width}" Height="{Binding Height}" Visibility="{Binding IsSelecting, Converter={StaticResource BooleanToVisibilityConverter}}" IsHitTestVisible="False">
                                                <Rectangle Canvas.Left="{Binding SelectionX}" Canvas.Top="{Binding SelectionY}"
                                                           Width="{Binding SelectionWidth}" Height="{Binding SelectionHeight}"
                                                           Fill="#500066CC" Stroke="#0066CC" StrokeThickness="1"/>
                                            </Canvas>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>
    </Grid>
</Window>