<Window x:Class="MinsPDFViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="MinsPDFViewer - Pro (OCR &amp; Annotation)" Height="800" Width="1200"
        Focusable="True" KeyDown="Window_KeyDown">
    
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Popup Name="SelectionPopup" Placement="Mouse" StaysOpen="False" AllowsTransparency="True">
            <Border Background="White" CornerRadius="8" BorderBrush="Gray" BorderThickness="1" Padding="5">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.3"/>
                </Border.Effect>
                <StackPanel Orientation="Horizontal">
                    <Button Click="BtnPopupCopy_Click" Background="Transparent" BorderThickness="0" ToolTip="복사" Margin="2">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="📄 복사" FontSize="12" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button>
                    
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                    
                    <Button Click="BtnPopupHighlightGreen_Click" Background="Transparent" BorderThickness="0" ToolTip="초록 형광펜" Margin="2">
                        <Border Width="16" Height="16" Background="#00FF00" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                    </Button>
                    <Button Click="BtnPopupHighlightOrange_Click" Background="Transparent" BorderThickness="0" ToolTip="주황 형광펜" Margin="2">
                        <Border Width="16" Height="16" Background="#FFA500" CornerRadius="2" BorderBrush="Gray" BorderThickness="1"/>
                    </Button>
                    
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}"/>
                    
                    <Button Click="BtnPopupUnderline_Click" Background="Transparent" BorderThickness="0" ToolTip="밑줄" Margin="2">
                        <TextBlock Text="U" FontWeight="Bold" TextDecorations="Underline" HorizontalAlignment="Center"/>
                    </Button>
                </StackPanel>
            </Border>
        </Popup>

        <Border Grid.Row="0" Background="#f0f0f0" Padding="10">
            <StackPanel Orientation="Horizontal">
                <Button Name="BtnOpen" Content="📂 열기" Width="60" Click="BtnOpen_Click" Margin="0,0,10,0"/>
                
                <Button Name="BtnSave" Content="💾 저장" Width="60" Click="BtnSave_Click" Margin="0,0,5,0" Background="#DDDDFF" ToolTip="현재 파일에 덮어쓰기"/>
                <Button Name="BtnSaveAs" Content="다른 이름으로.." Width="90" Click="BtnSaveAs_Click" Margin="0,0,10,0" Background="#EEEEFF" ToolTip="경로 지정하여 저장"/>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                <Button Content="↔ 너비 맞춤" Click="BtnFitWidth_Click" Margin="2,0" Padding="5,0"/>
                <Button Content="↕ 세로 맞춤" Click="BtnFitHeight_Click" Margin="2,0" Padding="5,0"/>
                
                <Button Content="-" Width="25" Click="BtnZoomOut_Click" Margin="5,0,0,0"/>
                <TextBlock Name="TxtZoom" Text="100%" VerticalAlignment="Center" Width="40" TextAlignment="Center"/>
                <Button Content="+" Width="25" Click="BtnZoomIn_Click" Margin="0,0,5,0"/>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>
                <TextBlock Text="도구: " VerticalAlignment="Center" FontWeight="Bold"/>
                <RadioButton Name="RbCursor" Content="선택" GroupName="Tools" IsChecked="True" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbHighlight" Content="그리기" GroupName="Tools" Click="Tool_Click" Margin="5,0"/>
                <RadioButton Name="RbText" Content="텍스트" GroupName="Tools" Click="Tool_Click" Margin="5,0"/>

                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>
                
                <TextBox Name="TxtSearch" Width="150" VerticalContentAlignment="Center" Margin="0,0,2,0" KeyDown="TxtSearch_KeyDown"/>
                <Button Content="&lt;" Width="20" Click="BtnPrevSearch_Click" ToolTip="이전 찾기 (Shift+Enter)" Margin="0,0,1,0"/>
                <Button Content="&gt;" Width="20" Click="BtnNextSearch_Click" ToolTip="다음 찾기 (Enter)" Margin="0,0,5,0"/>
                <Button Name="BtnSearch" Content="🔍 검색" Width="50" Click="BtnSearch_Click"/>
                <TextBlock Name="TxtStatus" VerticalAlignment="Center" Margin="10,0,0,0" Foreground="Gray"/>
            </StackPanel>
        </Border>

        <ListView Name="PdfListView" Grid.Row="1" Background="#505050" 
                  ScrollViewer.HorizontalScrollBarVisibility="Auto"
                  Padding="20" BorderThickness="0"
                  VirtualizingPanel.ScrollUnit="Pixel"
                  PreviewMouseWheel="PdfListView_PreviewMouseWheel">
            
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                    <Setter Property="Margin" Value="0,0,0,30"/>
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <ContentPresenter/>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>

            <ListView.LayoutTransform>
                <ScaleTransform x:Name="ViewScaleTransform" ScaleX="1.0" ScaleY="1.0"/>
            </ListView.LayoutTransform>

            <ListView.ItemTemplate>
                <DataTemplate>
                    <Grid>
                        <Image Source="{Binding ImageSource}" Stretch="Uniform" Width="{Binding Width}" Height="{Binding Height}">
                            <Image.Effect>
                                <DropShadowEffect BlurRadius="15" ShadowDepth="5" Opacity="0.4"/>
                            </Image.Effect>
                        </Image>
                        
                        <Canvas Width="{Binding Width}" Height="{Binding Height}">
                            <ItemsControl ItemsSource="{Binding Annotations}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="{Binding Width}" Height="{Binding Height}" 
                                                Background="{Binding Background}"
                                                BorderBrush="{Binding BorderBrush}"
                                                BorderThickness="{Binding BorderThickness}"
                                                Tag="{Binding}"
                                                ToolTip="우클릭하여 삭제">
                                            <Border.ContextMenu>
                                                <ContextMenu>
                                                    <MenuItem Header="삭제" Click="BtnDeleteAnnotation_Click" CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.Tag}"/>
                                                </ContextMenu>
                                            </Border.ContextMenu>
                                            <TextBlock Text="{Binding TextContent}" FontSize="12" Foreground="Black" 
                                                       Visibility="{Binding HasText, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Canvas>

                        <Canvas Width="{Binding Width}" Height="{Binding Height}" Visibility="{Binding IsSelecting, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Rectangle Canvas.Left="{Binding SelectionX}" Canvas.Top="{Binding SelectionY}"
                                        Width="{Binding SelectionWidth}" Height="{Binding SelectionHeight}"
                                        Fill="#500066CC" Stroke="#0066CC" StrokeThickness="1"/>
                        </Canvas>

                        <Canvas Width="{Binding Width}" Height="{Binding Height}" Background="Transparent"
                                Tag="{Binding PageIndex}"
                                PreviewMouseLeftButtonDown="Page_MouseDown"
                                PreviewMouseMove="Page_MouseMove"
                                PreviewMouseLeftButtonUp="Page_MouseUp"/>
                    </Grid>
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>
    </Grid>
</Window>